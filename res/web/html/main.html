<!DOCTYPE HTML>
<html>
    <head>
        <title>
            Pi Camera Controller
        </title>
        <link rel="stylesheet" href="/include/css/common.css">
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    </head>
    <body>
        <script type="text/javascript">
            /*
                Show / hide panels
             */
            function hideRecordSettings() {
                hideElementID("start_settings_div");
                hideElementID("invalid_time_div");
            }

            function hideSnapSettings() {
                hideElementID("snapshot_div");
            }

            function showRecordSettings() {
                showFlexElementID("start_settings_div");
                hideElementID("invalid_time_div");

                hideSnapSettings();
            }

            function showSnapshot() {
                showFlexElementID("snapshot_div");

                hideRecordSettings();
            }

            function showSettings() {
                showFlexElementID("settings_div");

                camera.getCamSettings(true, function(req, json) {
                    document.getElementById("vid_defaults_field").value = json.settings;
                });
                camera.getCamSettings(false, function(req, json) {
                    document.getElementById("snap_defaults_field").value = json.settings;
                });
                camera.getSystemSettings(function(req, json) {
                    document.getElementById("picam_config_text").value = json.settings;
                });
            }

            function hideSettings() {
                hideElementID("settings_div");
            }

            function showVideos() {
                let divName = "video_list_div";
                showFlexElementID(divName);
                createFilelist(true, divName, "Video");
            }

            function showSnapshots() {
                let divName = "snapshot_list_div";
                showFlexElementID(divName);
                createFilelist(false, divName, "Snapshot");
            }

            function closeSnapPreview() {
                hideElementID("preview_snap_div");
            }

            /*
                Trigger camera functions
             */
            function startRecord() {
                let time = document.getElementById("record_time").value;
                let path = document.getElementById("record_text").value;

                if (isNaN(time)) {
                    showFlexElementID("invalid_time_div");
                } else {
                    hideRecordSettings();
                    hideSnapSettings();
                    hideElementID("record_row");

                    camera.recordVideo(time, path);
                }
            }

            function takeSnapshot() {
                camera.recordSnapshot(document.getElementById("snapshot_name").value, function (){
                    camera.getSnapshotPreview(function (req, json){
                       showPreview('p', json.name);
                    });
                });
            }

            function showPreview(filetype, filename) {
                if (filetype === 'p') {
                    let img = document.getElementById("preview_snap_img");
                    img.src = "/func/media/download?p=" + filename;

                    showFlexElementID("preview_snap_div");
                } else if (filetype === 'v') {
                    let vid = document.getElementById("preview_vid_img");
                    vid.src = "/func/media/stream?" + filename;

                    showFlexElementID("preview_vid_div");
                } else {
                    console.log("Invalid preview type: " + filetype);
                }
            }

            function closeVidPreview() {
                hideElementID("preview_vid_div");
            }

            function resetVidSettings() {
                camera.resetCamSettings(true, function() {
                    populateCamSettings(true, document.getElementById("vid_defaults_field"));
                });
            }

            function resetSnapSettings() {
                camera.resetCamSettings(false, function() {
                    populateCamSettings(true, document.getElementById("snap_defaults_field"));
                });
            }

            function populateCamSettings(isVideo, field) {
                camera.getCamSettings(isVideo, function(req, json) {
                    field.value = JSON.stringify(json);
                });
            }

            function resetPiCamConfig() {
                camera.resetSystemSettings(function () {
                    populateSystemSettings();
                });
            }

            function populateSystemSettings() {
                camera.getSystemSettings(function (req, json) {
                    let text = document.getElementById("picam_config_text");
                    text.value = JSON.stringify(json);
                });
            }

            function applyPiCamConfig() {
                let text = document.getElementById("picam_config_text");
                camera.applySystemSettings(text.value);
            }

            function saveVidSettings() {
                let field = document.getElementById("vid_defaults_field");
                camera.applyCamSettings(true, field.value);
            }

            function saveSnapSettings() {
                let field = document.getElementById("snap_defaults_field");
                camera.applyCamSettings(false, field.value);
            }
        </script>

        <!-- Main window grid -->
        <div class="grid_main">

            <!-- javascript warning message, removed if javascript loads -->
            <div class="warning_message" id="javascript_warning">
                This site requires javascript to work correctly.
            </div>

            <!-- banner that show version -->
            <h1 class="top_grid_row" id="controller_version">
                Pi Camera Controller ???
            </h1>

            <!-- First row, shows camera recording status -->
            <div class="grid_row">
                <div class="grid_item_long">
                    Camera status:
                </div>
                <div class="grid_item" id="cam_status">
                    <div style="color: yellow">
                        unknown
                    </div>
                </div>
            </div>

            <!-- Second row, recording buttons -->
            <div class="grid_row" id="record_row">
                <div class="grid_item_long">
                    Record:
                </div>
                <!-- Record a video -->
                <div class="grid_item">
                    <input type="button" value="Video" onclick="showRecordSettings()">
                </div>
                <!-- Record a snapshot-->
                <div class="grid_item">
                    <input type="button" value="Snapshot" onclick="showSnapshot()">
                </div>
            </div>

            <!-- hidden inner grid, settings for recording video -->
            <div class="inner_grid_main" id="start_settings_div" style="display: none; justify-content: flex-start">
                <!-- first row of hidden grid, title/record button -->
                <div class="inner_grid_row">
                    <div class="grid_item_title">
                        Record video:
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Start" onclick="startRecord()">
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Cancel" onclick="hideRecordSettings()">
                    </div>
                </div>
                <!-- second hidden row, duration setting -->
                <div class="inner_grid_row" style="align-items: baseline">
                    <div class="grid_item_long">
                        Duration:
                    </div>
                    <div class="grid_item">
                        <input type="text" id="record_time" value="0">
                    </div>
                </div>
                <!-- third hidden row, output filename -->
                <div class="inner_grid_row" style="align-items: baseline">
                    <p class="grid_item_long">
                        Filename:
                    </p>
                    <div class="grid_item">
                        <input type="text" id="record_text" value="my_video">
                    </div>
                </div>
            </div>

            <!-- hidden warning row, displayed if duration is not an integer -->
            <div class="grid_row" id="invalid_time_div" style="display: none; color: red;">
                Please enter a number of seconds to record for, <br>
                or enter 0 to record until canceled.<br>
                <input type="button" value="Close" onclick="hideElementID('invalid_time_div')">
            </div>

            <!-- hidden row for recording progress -->
            <div class="grid_row" id="rec_progress_div" style="display: none">
                <div class="grid_item">
                    Recording to:
                </div>
                <div class="grid_item" id="recording_path">
                    N/A
                </div>
                <br>
                <div class="grid_item">
                    Time:
                </div>
                <div class="grid_item" id="recording_time">
                    N/A
                </div>
                <div class="grid_item">
                    <input type="button" value="Stop" onclick="camera.stopRecording()">
                </div>
            </div>

            <!-- hidden inner grid for recording snapshots -->
            <div class="inner_grid_main" id="snapshot_div" style="display: none">
                <!-- inner row with title / record button -->
                <div class="inner_grid_row">
                    <div class="grid_item_title">
                        Record snapshot:
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Save" onclick="takeSnapshot()">
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Cancel" onclick="hideSnapSettings()">
                    </div>
                </div>
                <!-- inner row with filename -->
                <div class="inner_grid_row">
                    <div class="grid_item_long">
                        Filename:
                    </div>
                    <div class="grid_item">
                        <input type="text" id="snapshot_name" value="my_picture">
                    </div>
                </div>
            </div>

            <!-- row with file browser buttons -->
            <div class="grid_row">
                <div class="grid_item_long">
                    Browse:
                </div>
                <div class="grid_item">
                    <input type="button" value="Video" onclick="showVideos()">
                </div>
                <div class="grid_item">
                    <input type="button" value="Snapshot" onclick="showSnapshots()">
                </div>
            </div>

            <!-- hidden inner grid with video files - populated by JS -->
            <div class="inner_grid_main" id="video_list_div" style="display: none">
            </div>

            <!-- hidden inner grid with video preview -->
            <div class="inner_grid_main" id="preview_vid_div" style="display: none">
                <div class="inner_grid_row">
                    <div class="grid_item_title">
                        Video preview:
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Close" onclick="closeVidPreview()">
                    </div>
                </div>
                <div class="inner_grid_row">
                    <div class="grid_item" style="max-width: 600px">
                        <video id="preview_vid_img" width="600" src="#" controls>
                            Your browser does not support video playback.
                        </video>
                    </div>
                </div>
            </div>

            <!-- hidden inner grid with snapshot files - populated by JS -->
            <div class="inner_grid_main" id="snapshot_list_div" style="display: none">
            </div>

            <!-- hidden inner grid with snapshot preview -->
            <div class="inner_grid_main" id="preview_snap_div" style="display: none">
                <div class="inner_grid_row">
                    <div class="grid_item_title">
                        Snapshot preview:
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Close" onclick="closeSnapPreview()">
                    </div>
                </div>
                <div class="inner_grid_row">
                    <div class="grid_item" style="max-width: 600px">
                        <img id="preview_snap_img" width="600" src="#" alt="Snapshot">
                    </div>
                </div>
            </div>

            <!-- system functions -->
            <div class="grid_row">
                <div class="grid_item_long">
                    System:
                </div>
                <!-- Admin -->
                <div class="grid_item">
                    <input type="button" value="Admin" onclick="showFlexElementID('admin_settings_div')">
                </div>
                <!-- Debug -->
                <div class="grid_item">
                    <input type="button" value="Debug" onclick="showFlexElementID('debug_settings_div')">
                </div>
                <!-- Settings -->
                <div class="grid_item">
                    <input type="button" value="Settings" onclick="showSettings()">
                </div>
            </div>

            <!-- hidden gridrow with settings -->
            <div class="inner_grid_main" id="settings_div" style="display: none">
                <!-- Title row -->
                <div class="inner_grid_row">
                    <div class="grid_item_title">
                        Camera settings:
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Close" onclick="hideSettings()">
                    </div>
                </div>
                <!-- video settings -->
                <div class="inner_grid_row">
                    <div class="grid_item_long">
                        Video defaults:
                    </div>
                    <div class="grid_item">
                        <input type="text" id="vid_defaults_field" value="">
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Save" onclick="saveVidSettings()">
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Reset" onclick="resetVidSettings()">
                    </div>
                </div>
                <!-- picture defaults -->
                <div class="inner_grid_row">
                    <div class="grid_item_long">
                        Snapshot defaults:
                    </div>
                    <div class="grid_item">
                        <input type="text" id="snap_defaults_field" value="">
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Save" onclick="saveSnapSettings()">
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Reset" onclick="resetSnapSettings()">
                    </div>
                </div>
                <!-- Empty divider row -->
                <div class="inner_grid_row"></div>
                <!-- Config header -->
                <div class="inner_grid_row">
                    <div class="grid_item_title">
                        PiCam config:
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Reset" onclick="resetPiCamConfig()">
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Apply" onclick="applyPiCamConfig()">
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Save" onclick="camera.saveSystemSettings()">
                    </div>
                </div>
                <!-- Config file contents -->
                <div class="inner_grid_row">
                    <div class="grid_item">
                        <textarea id="picam_config_text" cols="60" rows="20"></textarea>
                    </div>
                </div>
            </div>

            <!-- hidden gridrow with admin settings -->
            <div class="inner_grid_main" id="admin_settings_div" style="display: none">
                <!-- Title row -->
                <div class="inner_grid_row">
                    <div class="grid_item_title">
                        Admin controls:
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Close" onclick="hideElementID('admin_settings_div')">
                    </div>
                </div>
                <!-- Power controls -->
                <div class="inner_grid_row">
                    <div class="grid_item_long">
                        Power:
                    </div>
                    <!-- Exit -->
                    <div class="grid_item">
                        <input type="button" value="Exit" onclick="camera.exitProgram()">
                    </div>
                    <!-- Reboot -->
                    <div class="grid_item">
                        <input type="button" value="Reboot" onclick="camera.rebootPi()">
                    </div>
                    <!-- Shutdown -->
                    <div class="grid_item">
                        <input type="button" value="Shutdown" onclick="camera.shutdownPi()">
                    </div>
                </div>
                <!-- Filesystem controls -->
                <div class="inner_grid_row">
                    <div class="grid_item_long">
                        Filesystem:
                    </div>
                    <!-- Clear cachr -->
                    <div class="grid_item">
                        <input type="button" value="Erase Cache" onclick="camera.eraseCache()">
                    </div>
                    <!-- Mount RO -->
                    <div class="grid_item">
                        <input type="button" value="Mount R/O" onclick="camera.remountFS(false)">
                    </div>
                    <!-- Mount RW -->
                    <div class="grid_item">
                        <input type="button" value="Mount R/W" onclick="camera.remountFS(true)">
                    </div>
                    <!-- Synchronise FS -->
                    <div class="grid_item">
                        <input type="button" value="Sync" onclick="camera.syncFS()">
                    </div>
                </div>
            </div>
            <!-- debug settings -->
            <div class="inner_grid_main" id="debug_settings_div" style="display: none">
                <!-- Title row -->
                <div class="inner_grid_row">
                    <div class="grid_item_title">
                        Debug tools:
                    </div>
                    <div class="grid_item">
                        <input type="button" value="Close" onclick="hideElementID('debug_settings_div')">
                    </div>
                </div>
                <!-- Speed test -->
                <div class="inner_grid_row">
                    <div class="grid_item_long">
                        Speed test:
                    </div>
                    <div class="grid_item">
                        <a href="/func/debug/speedtest?1">XS</a>
                    </div>
                    <div class="grid_item">
                        <a href="/func/debug/speedtest?64">S</a>
                    </div>
                    <div class="grid_item">
                        <a href="/func/debug/speedtest?128">M</a>
                    </div>
                    <div class="grid_item">
                        <a href="/func/debug/speedtest?256">L</a>
                    </div>
                    <div class="grid_item">
                        <a href="/func/debug/speedtest?1024">XL</a>
                    </div>
                </div>
            </div>
        </div>

        <script src="/include/js/common.js"></script>
        <script src="/include/js/camera.js"></script>
        <script src="/include/js/status.js"></script>
        <script src="/include/js/filelist.js"></script>
    </body>
</html>